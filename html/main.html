<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>경제 키워드 트렌드</title>

    <link rel="icon" href="./img/favicon.png">
    <link rel="stylesheet" href="my_page_style.css" />
    <link rel="stylesheet" href="main_style.css" />
</head>

<body>
    <header class="header">
        <div class="header-inner">
            <a class="brand" href="./home.html">
                <span class="sidebar_logo"><img src="./img/logo_white.png" alt=""></span>
            </a>
            <a href="./home.html" class="logout-button">로그아웃</a>
        </div>
    </header>

    <div class="app">
        <aside class="sidebar">
            <ul class="menu">
                <li><a href="./main.html">경제 키워드 트렌드</a></li>
                <li><a href="#main2" class="js-scroll">기사</a></li>
                <li><a href="#main3" class="js-scroll">키워드 언급량 및 감성분석</a></li>
                <li><a href="./word.html">단어 사전</a></li>
                <li><a href="./my_page.html">마이페이지</a></li>
            </ul>
        </aside>

        <main class="mains">
            <section class="main1-panel">

                <!-- 상단 필터 바 -->
                <div class="main-toolbar">
                    <div class="date-range">
                        <label class="date-pill">
                            <span class="date-icon" aria-hidden="true">📅</span>
                            <span class="date-label">시작일</span>
                            <input id="startDate" type="date" value="2025-12-17" />
                        </label>

                        <label class="date-pill">
                            <span class="date-icon" aria-hidden="true">📅</span>
                            <span class="date-label">종료일</span>
                            <input id="endDate" type="date" value="2025-12-18" />
                        </label>


                        <div class="segmented" role="tablist" aria-label="기간 단위">
                            <button type="button" class="seg-btn is-active" data-grain="day" role="tab"
                                aria-selected="true">일별</button>
                            <button type="button" class="seg-btn" data-grain="week" role="tab"
                                aria-selected="false">주별</button>
                            <button type="button" class="seg-btn" data-grain="month" role="tab"
                                aria-selected="false">월별</button>
                            <button type="button" class="seg-btn" data-grain="year" role="tab"
                                aria-selected="false">연도별</button>
                        </div>
                    </div>

                    <!-- 오른쪽 드롭다운 -->
                    <div class="toolbar-right">
                        <div class="cselect" id="keywordDropdown">
                            <button type="button" class="cselect__btn" aria-haspopup="listbox" aria-expanded="false">
                                <span class="cselect__value">부동산</span>
                                <span class="cselect__caret" aria-hidden="true">▾</span>
                            </button>

                            <ul class="cselect__list" role="listbox" tabindex="-1" aria-label="키워드 선택">
                                <li class="cselect__opt" role="option" data-value="주식">주식</li>
                                <li class="cselect__opt is-selected" role="option" data-value="부동산"
                                    aria-selected="true">부동산</li>
                                <li class="cselect__opt" role="option" data-value="고용">고용</li>
                                <li class="cselect__opt" role="option" data-value="경기침체">경기침체</li>
                                <li class="cselect__opt" role="option" data-value="유가">유가</li>
                                <li class="cselect__opt" role="option" data-value="반도체">반도체</li>
                                <li class="cselect__opt" role="option" data-value="수출">수출</li>
                                <li class="cselect__opt" role="option" data-value="노동">노동</li>
                                <li class="cselect__opt" role="option" data-value="경제">경제</li>
                                <li class="cselect__opt" role="option" data-value="현금">현금</li>
                            </ul>

                            <input type="hidden" name="keyword" value="주식">
                        </div>
                    </div>
                </div>

                <!-- 본문 -->
                <div class="main1-body">
                    <!-- 키워드 랭킹 -->
                    <section class="ranking">
                        <div class="section-head">
                            <div class="section-head-left">
                                <h2 class="section-title">키워드 랭킹</h2>
                                <span class="pill">TOP10</span>
                            </div>

                            <div class="section-note rate-move-note">
                                <span class="note-text">날짜를 지정할 경우 증가율 · 변동 정보는 제공되지 않습니다.</span>
                            </div>
                        </div>

                        <div class="rank-table">
                            <div class="rank-row rank-head">
                                <div class="c-rank">순위</div>
                                <div class="c-keyword">키워드</div>
                                <div class="c-count">언급량</div>
                                <div class="c-rate has-tip">증감률
                                    <button type="button" class="info-btn" aria-label="증감률 안내"
                                        aria-expanded="false">i</button>
                                    <div class="tooltip" role="tooltip" hidden>
                                        선택한 기간의 종료일 기준 언급량을<br>
                                        이전 동일 기간과 비교한 변화 비율입니다.<br><br>
                                        이전 기간 언급량이 없는 경우 NEW로 표시됩니다.
                                    </div>
                                </div>
                                <div class="c-move has-tip">변동
                                    <button type="button" class="info-btn" aria-label="변동 안내"
                                        aria-expanded="false">i</button>
                                    <div class="tooltip" role="tooltip" hidden>
                                        선택한 기간의 키워드 순위가 <br>
                                        종료일 기준으로 이전 동일 기간과 비교해 <br>
                                        얼마나 변했는지를 나타냅니다.<br><br>
                                        이전 기간 언급량이 없는 경우 NEW로 표시됩니다.
                                    </div>
                                </div>
                            </div>

                            <div id="rankList" class="rank-list" role="list"></div>
                        </div>
                    </section>

                    <!-- 기사 요약 패널 -->
                    <aside class="summary">
                        <p>※ 기사 요약 정보는 일별 선택을 했을 때만 제공됩니다.</p>
                        <div class="summary-card">
                            <div class="summary-title">
                                <span class="tag">기사 요약</span>
                                <strong id="summaryKeyword">주식</strong>
                            </div>

                            <div class="summary-content">
                                <div class="summary-subhead">선정이유</div>
                                <ol id="summaryList" class="summary-list"></ol>
                            </div>
                        </div>
                    </aside>
                </div>
            </section>

            <section id="main2" class="ts2-panel" aria-label="기사">
                <div class="ts2-grid">
                    <!-- 긍정 -->
                    <section class="ts2-col ts2-col--pos" aria-label="긍정 기사섹션">
                        <div class="ts2-colhead">
                            <div class="ts2-coltitle">
                                <h3 class="ts2-h">긍정 기사섹션</h3>
                                <span class="ts2-pill ts2-pill--pos">긍정</span>
                            </div>

                            <select class="ts2-select" data-sort="pos" aria-label="긍정 정렬">
                                <option value="recent">최신순</option>
                                <option value="old">오래된순</option>
                                <option value="popular">인기순</option>
                            </select>
                        </div>

                        <div class="ts2-colbody">
                            <div class="ts2-list" id="ts2ListPos"></div>

                            <div class="ts2-pager" aria-label="긍정 페이지네이션">
                                <button class="ts2-pagebtn" type="button">«</button>
                                <span class="ts2-pagetext">1 / N</span>
                                <button class="ts2-pagebtn" type="button">»</button>
                            </div>
                        </div>
                    </section>

                    <!-- 중립 -->
                    <section class="ts2-col ts2-col--neu" aria-label="중립 기사섹션">
                        <div class="ts2-colhead">
                            <div class="ts2-coltitle">
                                <h3 class="ts2-h">중립 기사섹션</h3>
                                <span class="ts2-pill ts2-pill--neu">중립</span>
                            </div>

                            <select class="ts2-select" data-sort="neu" aria-label="중립 정렬">
                                <option value="recent">최신순</option>
                                <option value="old">오래된순</option>
                                <option value="popular">인기순</option>
                            </select>
                        </div>

                        <div class="ts2-colbody">
                            <div class="ts2-list" id="ts2ListNeu"></div>

                            <div class="ts2-pager" aria-label="중립 페이지네이션">
                                <button class="ts2-pagebtn" type="button">«</button>
                                <span class="ts2-pagetext">1 / N</span>
                                <button class="ts2-pagebtn" type="button">»</button>
                            </div>
                        </div>
                    </section>

                    <!-- 부정 -->
                    <section class="ts2-col ts2-col--neg" aria-label="부정 기사섹션">
                        <div class="ts2-colhead">
                            <div class="ts2-coltitle">
                                <h3 class="ts2-h">부정 기사섹션</h3>
                                <span class="ts2-pill ts2-pill--neg">부정</span>
                            </div>

                            <select class="ts2-select" data-sort="neg" aria-label="부정 정렬">
                                <option value="recent">최신순</option>
                                <option value="old">오래된순</option>
                                <option value="popular">인기순</option>
                            </select>
                        </div>

                        <div class="ts2-colbody">
                            <div class="ts2-list" id="ts2ListNeg"></div>

                            <div class="ts2-pager" aria-label="부정 페이지네이션">
                                <button class="ts2-pagebtn" type="button">«</button>
                                <span class="ts2-pagetext">1 / N</span>
                                <button class="ts2-pagebtn" type="button">»</button>
                            </div>
                        </div>
                    </section>

                </div>
            </section>

        </main>
    </div>

    <script>
        // ===== 사이드바 현재 페이지 active 처리 =====
        document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
        document.querySelectorAll('.menu a').forEach(a => {
            const aPath = new URL(a.href, location.origin).pathname.split('/').pop();
            const curPath = location.pathname.split('/').pop();
            if (aPath === curPath) a.closest('li').classList.add('active');
        });

        // ===== 샘플 데이터 =====
        const KEYWORDS = [
            { rank: 1, keyword: "주식", count: 223, rate: +94, move: "NEW" },
            { rank: 2, keyword: "부동산", count: 201, rate: -22, move: "▼2" },
            { rank: 3, keyword: "고용", count: 189, rate: +10, move: "▲1" },
            { rank: 4, keyword: "경기침체", count: 173, rate: -7, move: "▼1" },
            { rank: 5, keyword: "유가", count: 162, rate: +18, move: "▲1" },
            { rank: 6, keyword: "반도체", count: 155, rate: +50, move: "▲3" },
            { rank: 7, keyword: "수출", count: 149, rate: -12, move: "▼2" },
            { rank: 8, keyword: "노동", count: 130, rate: -42, move: "▼3" },
            { rank: 9, keyword: "경제", count: 121, rate: +8, move: "▲1" },
            { rank: 10, keyword: "현금", count: 108, rate: -13, move: "▼1" },
        ];

        const SUMMARY_MAP = {
            "주식": [
                "키워드 관련 기사 목록 조회(2~06건)",
                "전체 요약 생성(기사 내용 기반, 800~1200자)",
                "요약 API 호출 및 저장(예: summary_all 필드)",
                "사용자 선택 시점에 요약 제공(드롭다운/행 클릭)",
                "키워드별 요약/메타정보(언급량, 증감률, 변동) 함께 표시"
            ],
            "부동산": [
                "부동산 정책/금리/거래량 관련 기사 우선 수집",
                "기간별 비교(전주/전월) 기반 증감률 계산",
                "중복 기사/유사 기사 제거 후 요약 생성",
                "요약 결과를 키워드별 캐싱하여 빠르게 제공",
                "핵심 지표(거래, 대출, 가격) 중심으로 요약 구성"
            ],
            "고용": [
                "고용지표/실업률/채용시장 관련 기사 분류",
                "산업별 이슈 키워드(제조/서비스 등) 태깅",
                "요약 생성 후 핵심 문장 3~5개로 정리",
                "기간 단위(일/주/월/연) 변경 시 재집계",
                "요약과 함께 관련 기사 링크/제목 리스트 확장 가능"
            ]
        };

        // dropdownApi는 selectKeyword에서 쓰므로 위에 선언 (TDZ 방지)
        let dropdownApi = null;

        // ===== DOM =====
        const rankListEl = document.getElementById("rankList");
        const summaryKeywordEl = document.getElementById("summaryKeyword");
        const summaryListEl = document.getElementById("summaryList");
        const segmentedBtns = Array.from(document.querySelectorAll(".seg-btn"));

        function fmtRate(n) {
            const sign = n > 0 ? "+" : "";
            return `${sign}${n}%`;
        }
        function rateClass(n) {
            if (n > 0) return "is-up";
            if (n < 0) return "is-down";
            return "is-flat";
        }
        function moveClass(move) {
            if (move === "NEW") return "is-new";
            if (String(move).includes("▲")) return "is-up";
            if (String(move).includes("▼")) return "is-down";
            return "is-flat";
        }

        function renderRanking(selectedKeyword) {
            if (!rankListEl) return;
            rankListEl.innerHTML = "";

            KEYWORDS.forEach((k) => {
                const row = document.createElement("button");
                row.type = "button";
                row.className = "rank-row rank-item" + (k.keyword === selectedKeyword ? " is-selected" : "");
                row.setAttribute("role", "listitem");

                row.innerHTML = `
          <div class="c-rank"><span class="rank-badge">${k.rank}</span></div>
          <div class="c-keyword">${k.keyword}</div>
          <div class="c-count">${k.count}</div>
          <div class="c-rate ${rateClass(k.rate)}">${fmtRate(k.rate)}</div>
          <div class="c-move ${moveClass(k.move)}">${k.move}</div>
        `;

                // 랭킹 클릭하면 selectKeyword 실행 (드롭다운도 같이 동기화)
                row.addEventListener("click", () => selectKeyword(k.keyword));
                rankListEl.appendChild(row);
            });
        }

        function renderSummary(keyword) {
            if (!summaryKeywordEl || !summaryListEl) return;

            summaryKeywordEl.textContent = keyword;
            summaryListEl.innerHTML = "";

            const items = SUMMARY_MAP[keyword] || SUMMARY_MAP["주식"];
            items.forEach((txt) => {
                const li = document.createElement("li");
                li.textContent = txt;
                summaryListEl.appendChild(li);
            });
        }

        function selectKeyword(keyword) {
            renderRanking(keyword);
            renderSummary(keyword);
            dropdownApi?.setValue(keyword); // 랭킹 클릭 시 드롭다운도 변경
        }

        // ===== 기간 탭 =====
        segmentedBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                segmentedBtns.forEach((b) => {
                    b.classList.remove("is-active");
                    b.setAttribute("aria-selected", "false");
                });
                btn.classList.add("is-active");
                btn.setAttribute("aria-selected", "true");
            });
        });

        // ===== 커스텀 드롭다운 =====
        (function () {
            const root = document.getElementById('keywordDropdown');
            if (!root) return;

            const btn = root.querySelector('.cselect__btn');
            const list = root.querySelector('.cselect__list');
            const valueEl = root.querySelector('.cselect__value');
            const hidden = root.querySelector('input[type="hidden"]');
            const options = Array.from(root.querySelectorAll('.cselect__opt'));

            if (!btn || !list || !valueEl || options.length === 0) return;

            let activeIndex = Math.max(0, options.findIndex(o => o.classList.contains('is-selected')));

            function close() {
                root.classList.remove('is-open');
                btn.setAttribute('aria-expanded', 'false');
            }
            function toggle() {
                root.classList.toggle('is-open');
                btn.setAttribute('aria-expanded', root.classList.contains('is-open') ? 'true' : 'false');
            }

            function applyValue(v) {
                options.forEach(o => {
                    const isMatch = (o.dataset.value ?? o.textContent.trim()) === v;
                    o.classList.toggle('is-selected', isMatch);
                    if (isMatch) o.setAttribute('aria-selected', 'true');
                    else o.removeAttribute('aria-selected');
                });

                valueEl.textContent = v;
                if (hidden) hidden.value = v;

                const idx = options.findIndex(o => (o.dataset.value ?? o.textContent.trim()) === v);
                if (idx >= 0) activeIndex = idx;
            }

            options.forEach(opt => {
                opt.addEventListener('click', () => {
                    const v = opt.dataset.value ?? opt.textContent.trim();
                    applyValue(v);
                    close();
                    selectKeyword(v); // 드롭다운 선택 -> 랭킹/요약 변경
                });
            });

            btn.addEventListener('click', (e) => {
                e.preventDefault();
                toggle();
            });

            document.addEventListener('click', (e) => {
                if (!root.contains(e.target)) close();
            });

            dropdownApi = {
                setValue(v) { applyValue(v); }
            };

            // 드롭다운 초기값 반영만 해둠 (렌더는 아래 boot에서 무조건 1회)
            const initial = (hidden?.value || valueEl.textContent || "주식").trim();
            applyValue(initial);
        })();

        // 초기 렌더는 무조건 1번 실행 (TOP10 첫 로드부터 보이게)
        const bootKeyword =
            (document.querySelector('#keywordDropdown input[type="hidden"]')?.value ||
                document.querySelector('#keywordDropdown .cselect__value')?.textContent ||
                '주식').trim();

        selectKeyword(bootKeyword);

        // ===== 증감률/변동 안내 툴팁 (각 has-tip 안에서만 토글) =====
        (function () {
            const wraps = document.querySelectorAll('.has-tip');
            if (!wraps.length) return;

            function closeAll() {
                wraps.forEach(w => {
                    const btn = w.querySelector('.info-btn');
                    const tip = w.querySelector('.tooltip');
                    if (!btn || !tip) return;
                    tip.hidden = true;
                    btn.setAttribute('aria-expanded', 'false');
                });
            }

            wraps.forEach(w => {
                const btn = w.querySelector('.info-btn');
                const tip = w.querySelector('.tooltip');
                if (!btn || !tip) return;

                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const willOpen = tip.hidden; // true면 열기
                    closeAll();
                    tip.hidden = !willOpen;
                    btn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
                });

                tip.addEventListener('click', (e) => e.stopPropagation());
            });

            document.addEventListener('click', closeAll);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeAll();
            });
        })();

        // 스크롤
        (function () {
            const scroller = document.querySelector('main.mains'); // 스크롤 컨테이너
            const links = document.querySelectorAll('.menu a.js-scroll[href^="#"]');
            if (!scroller || !links.length) return;

            function scrollToInContainer(target) {
                const top =
                    target.getBoundingClientRect().top -
                    scroller.getBoundingClientRect().top +
                    scroller.scrollTop;

                scroller.scrollTo({ top: Math.max(0, top - 12), behavior: 'smooth' });
            }

            links.forEach(a => {
                a.addEventListener('click', (e) => {
                    const id = a.getAttribute('href').slice(1);
                    const target = document.getElementById(id);
                    if (!target) return;

                    e.preventDefault();
                    scrollToInContainer(target);

                    // active 처리(원하면)
                    document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
                    a.closest('li')?.classList.add('active');

                    history.replaceState(null, '', `#${id}`);
                });
            });
        })();



        (function TS2() {
            const data = [
                // pos
                { sent: 'pos', source: '한국경제', flag: '정상', date: '2025-12-18', popular: 32, title: '물가 둔화 신호…시장 반응', desc: '최신 발표된 소비자물가 지표가 예상보다 낮게 나오면서 금리 인하 기대가 일부 반영됐습니다…' },
                { sent: 'pos', source: '연합뉴스', flag: '정상', date: '2025-12-15', popular: 21, title: '기업 실적 개선 기대 확산', desc: '주요 업종에서 실적 상향 전망이 확대되며 투자 심리가 개선되는 모습입니다…' },
                { sent: 'pos', source: '매일경제', flag: '의심', date: '2025-12-13', popular: 11, title: '연준 발언에 환율 출렁…', desc: '발언 강도에 따라 달러/원 환율 변동성이 확대되는 흐름입니다…' },

                // neu
                { sent: 'neu', source: '연합뉴스', flag: '정상', date: '2025-12-18', popular: 27, title: '연준 발언에 환율 출렁…', desc: '정책 경로에 대한 해석 차이로 환율이 등락을 반복했습니다…' },
                { sent: 'neu', source: '한국경제', flag: '정상', date: '2025-12-18', popular: 19, title: '기준금리 동결…부채 부담', desc: '동결 기조 속에서도 가계·기업의 이자 부담이 이어지고 있습니다…' },
                { sent: 'neu', source: '매일경제', flag: '의심', date: '2025-12-13', popular: 9, title: '기업 실적 개선 기대 확산', desc: '실적 기대감이 확대되는 가운데 업종별 차별화가 관측됩니다…' },

                // neg
                { sent: 'neg', source: '한국경제', flag: '정상', date: '2025-12-18', popular: 35, title: '부동산 규제 완화 논의', desc: '일부 지역 거래 위축이 이어지자 규제 완화 논의가 진행되고 있습니다…' },
                { sent: 'neg', source: '연합뉴스', flag: '정상', date: '2025-12-14', popular: 22, title: '기업 실적 개선 기대 확산', desc: '기대감에도 불구하고 대외 변수 리스크가 상존한다는 분석입니다…' },
                { sent: 'neg', source: '매일경제', flag: '의심', date: '2025-12-12', popular: 15, title: '물가 둔화 신호…시장 반응', desc: '일시적 요인인지 추세 변화인지에 대한 논쟁이 이어지고 있습니다…' },
            ];

            const els = {
                pos: document.getElementById('ts2ListPos'),
                neu: document.getElementById('ts2ListNeu'),
                neg: document.getElementById('ts2ListNeg'),
            };

            function parseDate(s) { return new Date(s + 'T00:00:00'); }

            function sortItems(items, mode) {
                const arr = [...items];
                if (mode === 'recent') arr.sort((a, b) => parseDate(b.date) - parseDate(a.date));
                if (mode === 'old') arr.sort((a, b) => parseDate(a.date) - parseDate(b.date));
                if (mode === 'popular') arr.sort((a, b) => (b.popular || 0) - (a.popular || 0));
                return arr;
            }

            function cardHTML(it) {
                return `
      <article class="ts2-card" tabindex="0">
        <div class="ts2-card__top">
          <span class="ts2-src">${it.source}</span>
          <span class="ts2-mini">${it.flag}</span>
        </div>
        <h4 class="ts2-title">${it.title}</h4>
        <p class="ts2-desc">${it.desc}</p>
        <div class="ts2-meta">
          <span class="ts2-chip ts2-chip--date">${it.date}</span>
          <button type="button" class="ts2-chip ts2-chip--btn">기사 요약</button>
        </div>
      </article>
    `;
            }

            function render(sent, mode = 'recent') {
                const target = els[sent];
                if (!target) return;

                const items = sortItems(data.filter(d => d.sent === sent), mode);
                target.innerHTML = items.map(cardHTML).join('');

                // 첫 카드 기본 펼침
                const first = target.querySelector('.ts2-card');
                if (first) first.classList.add('is-open');

                // 클릭하면 해당 카드만 펼침
                target.querySelectorAll('.ts2-card').forEach(card => {
                    card.addEventListener('click', () => {
                        target.querySelectorAll('.ts2-card').forEach(c => c.classList.remove('is-open'));
                        card.classList.add('is-open');
                    });
                });

                // "기사 요약" 버튼은 카드 클릭 이벤트랑 분리하고 싶으면 여기서 stopPropagation
                target.querySelectorAll('.ts2-chip--btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // TODO: 요약 모달/패널 열기 연결
                        alert('기사 요약(샘플) 연결 지점!');
                    });
                });
            }

            // 초기 렌더
            render('pos', 'recent');
            render('neu', 'recent');
            render('neg', 'recent');

            // 정렬 셀렉트 연결
            document.querySelectorAll('.ts2-select[data-sort]').forEach(sel => {
                sel.addEventListener('change', () => {
                    const sent = sel.getAttribute('data-sort');
                    render(sent, sel.value);
                });
            });
        })();

    </script>
</body>

</html>