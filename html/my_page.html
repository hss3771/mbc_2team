<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>비밀번호 확인</title>

  <link rel="icon" href="./img/favicon.png">
  <link rel="stylesheet" href="my_page_style.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
  <header class="header">
    <div class="header-inner">
      <a class="brand" href="./home.html">
        </span>
        <span class="sidebar_logo"><img src="./img/logo_white.png" alt=""></span>
      </a>
      <a href="./home.html" class="logout-button">로그아웃</a>
    </div>
  </header>

  <div class="app">
    <aside class="sidebar">
      <ul class="menu">
        <li><a href="./main.html">경제 키워드 트렌드</a></li>
        <li><a href="./main.html#main2">기사</a></li>
        <li><a href="./main.html#main3">키워드 언급량 및 감성분석</a></li>
        <li><a href="./word.html">단어 사전</a></li>
        <li><a href="./my_page.html">마이페이지</a></li>
      </ul>
    </aside>
    <main class="content">
      <div class="card">
        <div class="card-top">
          <h2>마이페이지</h2>
          <p class="description">마이페이지 조회를 위해 비밀번호 확인이 필요합니다.</p>
        </div>

        <div class="card-scroll">
          <form action="info_edit.html" method="get" id="pwForm" class="form">
            <label for="password" class="visually-hidden">비밀번호</label>
            <input type="password" id="password" name="password" placeholder="비밀번호를 입력해 주세요." required />
            <p id="pwError" class="error" aria-live="polite"></p>
            <button type="submit" class="OK">확인</button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script>
  // ====== 사이드바 active ======
  function setSidebarActive() {
    const curFileRaw = (location.pathname.split('/').pop() || '').split('?')[0].split('#')[0];
    const curHash = location.hash || '';

    const alias = { 'info_edit.html': 'my_page.html' };
    const curFile = alias[curFileRaw] || curFileRaw;

    document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
    const links = Array.from(document.querySelectorAll('.menu a'));

    if (curFile === 'main.html' && (curHash === '#main2' || curHash === '#main3')) {
      const hashTarget = links.find(a => {
        const href = a.getAttribute('href') || '';
        const [filePart, hashPart] = href.split('#');
        const file = (filePart.split('/').pop() || '');
        const hash = hashPart ? ('#' + hashPart) : '';
        return file === 'main.html' && hash === curHash;
      });
      if (hashTarget) {
        hashTarget.closest('li')?.classList.add('active');
        return;
      }
    }

    const fileTarget = links.find(a => {
      const href = a.getAttribute('href') || '';
      const file = (href.split('#')[0].split('/').pop() || '');
      return file === curFile;
    });

    fileTarget?.closest('li')?.classList.add('active');
  }

  setSidebarActive();
  window.addEventListener('hashchange', setSidebarActive);

  // ====== 비밀번호 확인(AJAX) ======
  const ENDPOINT_VERIFY_PW = "/mypage/password_check";

  function requestVerifyPassword(pw) {
    return $.ajax({
      url: ENDPOINT_VERIFY_PW,
      method: "POST",
      dataType: "text", // ✅ 성공 시 redirect(HTML)가 올 수 있어 text로
      data: { pw },     // ✅ FastAPI Form(pw)에 맞춤
      timeout: 10000,
      xhrFields: { withCredentials: true }
    });
  }

  // ✅ my_page.html의 실제 요소 id에 맞춤
  // - form: #pwForm
  // - password input: #password
  // - error p: #pwError
  $("#pwForm").on("submit", function (e) {
    e.preventDefault();

    const pw = $("#password").val().trim();
    if (!pw) {
      $("#pwError").text("비밀번호를 입력해 주세요.");
      return;
    }
    $("#pwError").text("");

    requestVerifyPassword(pw)
      .done((raw) => {
        // 실패면 JSON 문자열이 올 수 있음: {"success":false,"message":"..."}
        try {
          const json = JSON.parse(raw);
          if (json && json.success === false) {
            $("#pwError").text(json.message || "비밀번호 확인 실패");
            return;
          }
        } catch (_) {
          // JSON 파싱 실패 = redirect 결과 HTML일 가능성이 큼 → 성공 처리
        }

        // ✅ info_edit에서 /info_update가 pw/pw_confirm 필수라서 저장(백 수정 없이 우회)
        sessionStorage.setItem("verifiedPw", pw);

        // ✅ ajax는 서버 redirect를 브라우저 이동으로 못 하니까 직접 이동
        window.location.href = "/view/info_edit.html";
      })
      .fail((xhr) => {
        if (xhr.status === 0) {
          $("#pwError").text("네트워크 오류가 발생했습니다.");
          return;
        }
        $("#pwError").text("비밀번호 확인 중 오류가 발생했습니다.");
      });
  });
</script>

</body>

</html>