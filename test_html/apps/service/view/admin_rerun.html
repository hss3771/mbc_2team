<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê´€ë¦¬ì - ìˆ˜ë™ ì¬ì‹¤í–‰</title>

  <link rel="icon" href="./img/favicon.png" />

  <link rel="stylesheet" href="/view/css/my_page_style.css" />
  <link rel="stylesheet" href="/view/css/main_style.css" />
  <link rel="stylesheet" href="/view/css/admin.css" />
  <link rel="stylesheet" href="/view/css/admin_rerun.css" />

  <style>
    body.preauth {
      visibility: hidden;
    }
  </style>
</head>

<body class="preauth layout-admin page-admin-rerun">
  <div id="headerMount" aria-label="ê³µí†µ í—¤ë”"></div>

  <div class="app">
    <aside id="sidebarMount" class="sidebar" aria-label="ì‚¬ì´ë“œë°”"></aside>
    <main class="mains">
      <!-- âœ… ì¶”ê°€: word.htmlì˜ "ë‹¨ì–´ ì‚¬ì „" ëŠë‚Œ -->
      <div class="admin-page-title">ê´€ë¦¬ì ì½˜ì†”</div>

      <div class="main-toolbar admin-toolbar">
        <div class="admin-pill" id="runRatePill" title="ì¬ë¶„ì„ ì§„í–‰ë¥ " hidden>
          <span class="admin-pill__label" id="runRateLabel">ì¬ë¶„ì„ ì‹¤í–‰ ì¤‘</span>
          <button type="button" class="admin-pill__info" id="runRateInfo" aria-label="ì§„í–‰ ì•ˆë‚´" title="ì•ˆë‚´">i</button>
          <strong id="runRate">(0%)</strong>
        </div>



        <div class="date-range admin-date-range">
          <label class="date-pill">
            <span class="date-icon" aria-hidden="true">ğŸ“…</span>
            <span class="date-label">ì‹œì‘ì¼</span>
            <input id="startDate" type="date" />
          </label>

          <label class="date-pill">
            <span class="date-icon" aria-hidden="true">ğŸ“…</span>
            <span class="date-label">ì¢…ë£Œì¼</span>
            <input id="endDate" type="date" />
          </label>

          <button type="button" class="admin-btn admin-btn--primary" id="btnSearch">ì¡°íšŒ</button>
          <button type="button" class="admin-btn admin-btn--ghost" id="btnRun" disabled>ì‹¤í–‰</button>
        </div>
      </div>

      <div class="main-scroll">
        <section class="admin-panel rerun-panel">
          <!-- ëª¨ë¸/ë¦¬ìŠ¤íŠ¸ ìƒë‹¨ ë°” -->
          <div class="rerun-bar">
            <!-- ì™¼ìª½: ê²°ì¸¡ì¹˜ LIST -->
            <div class="rerun-bar__left">
              <div class="rerun-list-title">ê²°ì¸¡ì¹˜ LIST</div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì¹©(Keyword~Summary + ì „ì²´ì„ íƒ + ì „ì²´í•´ì œ) -->
            <div class="rerun-bar__right">
              <div class="rerun-chips" id="modelChips" aria-label="ë¶„ì„ ëª¨ë¸ ì„ íƒ">
                <!-- âœ… ì„¤ê³„ì„œ ìˆœì„œ: keyword â†’ sentiment â†’ trust â†’ summary â†’ ì „ì²´ì„ íƒ â†’ ì „ì²´í•´ì œ -->
                <button type="button" class="rerun-chip is-active" data-model="keyword">
                  <span class="rerun-dot" aria-hidden="true"></span> Keyword
                </button>

                <button type="button" class="rerun-chip is-active" data-model="sentiment">
                  <span class="rerun-dot" aria-hidden="true"></span> Sentiment
                </button>

                <button type="button" class="rerun-chip is-active" data-model="trust">
                  <span class="rerun-dot" aria-hidden="true"></span> Trust
                </button>

                <button type="button" class="rerun-chip is-active" data-model="summary">
                  <span class="rerun-dot" aria-hidden="true"></span> Summary
                </button>

                <button type="button" class="rerun-chip rerun-chip--mini" id="chipAll">ì „ì²´ ì„ íƒ</button>
                <button type="button" class="rerun-chip rerun-chip--mini" id="chipClear">ì „ì²´ í•´ì œ</button>
              </div>

              <!-- âœ… 'ì´ˆê¸°ê°’ìœ¼ë¡œ'ëŠ” UIì—ì„œ ì œê±°(ìˆ¨ê¹€)
                     (JSê°€ btnResetì„ ì°¸ì¡°í•  ìˆ˜ ìˆì–´ì„œ hiddenìœ¼ë¡œë§Œ ìœ ì§€) -->
              <button type="button" class="admin-btn admin-btn--ghost" id="btnReset" hidden aria-hidden="true"
                tabindex="-1">ì´ˆê¸°ê°’ìœ¼ë¡œ</button>
            </div>
          </div>


          <div class="admin-table-wrap rerun-table-wrap">
            <table class="admin-table">
              <thead>
                <tr>
                  <th style="width:54px;">
                    <input type="checkbox" class="rerun-check" id="checkAllRows" aria-label="ì „ì²´ ì„ íƒ" />
                  </th>
                  <th style="width:360px;">article_id</th>
                  <th data-col="keyword">Keyword</th>
                  <th data-col="sentiment">Sentiment</th>
                  <th data-col="trust">Trust</th>
                  <th data-col="summary">Summary</th>
                </tr>
              </thead>
            </table>

            <div class="admin-table-body rerun-table-body" id="tableBodyWrap">
              <table class="admin-table admin-table--body">
                <tbody id="tbodyArticles"></tbody>
              </table>
            </div>

            <div class="admin-empty" id="emptyState" hidden>
              ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
              <div class="rerun-empty-sub" id="emptyHint">ì¡°ê±´ì„ ë³€ê²½í•œ ë’¤ ì¡°íšŒí•´ ì£¼ì„¸ìš”.</div>
            </div>
          </div>
        </section>

        <div class="admin-toast" id="toast" hidden>
          <div class="admin-toast__icon">i</div>
          <div class="admin-toast__text" id="toastText"></div>
          <button class="admin-toast__close" id="btnToastClose" aria-label="ë‹«ê¸°">Ã—</button>
        </div>

        <div class="admin-confirm" id="confirmModal" hidden>
          <div class="admin-confirm__backdrop" data-close="true"></div>
          <div class="admin-confirm__card" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
            <div class="admin-confirm__title" id="confirmTitle">â€» ì‹¤í–‰ ì „ í™•ì¸ â€»</div>
            <div class="admin-confirm__desc" id="confirmDesc"></div>
            <div class="admin-confirm__actions">
              <button type="button" class="admin-btn admin-btn--ghost" id="btnConfirmCancel">ì·¨ì†Œ</button>
              <button type="button" class="admin-btn admin-btn--primary" id="btnConfirmOk">í™•ì¸</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/static/header_init.js" defer></script>
  <script src="/static/sidebar_init.js" defer></script>
  <script src="/static/sidebar.js" defer></script>

  <script>
    async function requireAdminOrRedirect() {
      try {
        const r = await fetch("/api/session", { credentials: "include", cache: "no-store" });
        if (!r.ok) throw new Error("session api failed");
        const body = await r.json();

        const loggedIn = !!body.logged_in;
        const isAdmin = loggedIn && !!body.admin_in;

        if (!loggedIn) {
          location.replace("/login");
          return false;
        }
        if (!isAdmin) {
          alert("ê´€ë¦¬ìë¡œ ë“±ë¡ëœ íšŒì›ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          location.replace("/main");
          return false;
        }

        document.body.classList.remove("preauth");
        return true;
      } catch (e) {
        location.replace("/login");
        return false;
      }
    }

    function loadRerunJs() {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "/static/admin_rerun.js";
        s.defer = true;
        s.onload = () => resolve(true);
        s.onerror = () => reject(new Error("failed to load /static/admin_rerun.js"));
        document.body.appendChild(s);
      });
    }

    (async function boot() {
      const ok = await requireAdminOrRedirect();
      if (!ok) return;

      try {
        await loadRerunJs();
      } catch (e) {
        console.error(e);
        alert("ê´€ë¦¬ì ìŠ¤í¬ë¦½íŠ¸ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    })();
  </script>
</body>

</html>